<head>
    <script language="javascript" type="text/javascript" src="../static/js/jquery_min.js"></script>
    <script language="javascript" type="text/javascript" src="../static/js/fabric.js"></script>
    <script language="javascript" type="text/javascript" src="{{=URL('static','js/jsfeat-min.js')}}"></script>
    <script type="text/javascript" src="../static/js/buttons.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/css/font-awesome_min.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="../static/css/canvas.css" media="screen" />
    <link rel="stylesheet" href="../static/css/newbuttons.css"/>
    <link rel="stylesheet" href="../static/css/menu.css"/>
</head>

<body>
<form>
    <input type="file" id="images" name="images[]" style="display: none;" multiple></input>
</form>

<div class="menu_background">
<div id="menu" class="main">
    <!--<a href="#" class="btn orange" id="btn_slide_menu"> <i class="fa fa-outdent"></i> Hide</a>-->
    <a href="#" class="btn blue"   onclick="toggleSubMenu('workMenu')">      <i class="fa fa-th-large"></i> Workspace</a>
    <a href="#" class="btn green"  onclick="toggleSubMenu('rectMenu')">      <i class="fa fa-pencil-square-o"></i> Rect </a>
    <a href="#" class="btn red"    onclick="toggleSubMenu('lineMenu')">      <i class="fa fa-ellipsis-h"></i> Line</a>
    <a href="#" class="btn purple" onclick="toggleSubMenu('filtersMenu')">   <i class="fa fa-arrows"></i> Filters</a>
    <a href="#" class="btn orange" onclick="toggleSubMenu(); clearCanvas()"> <i class="fa fa-eraser"></i> Clean</a>
    <a href="#" class="btn orange" onclick="toggleSubMenu(); viewLarge2();"> <i class="fa fa-arrows"></i> View Large</a>
</div>

<div id="rectMenu" class="submenu">
     <a href="#" class="btn green" onclick="draw_rect_button_click()"> <i class="fa fa-pencil"></i> Draw</a>
     <a href="#" class="btn green" onclick="hideRect()">               <i class="fa fa-retweet"></i> Hide</a>
     <a href="#" class="btn green" onclick="eraseRect()">              <i class="fa fa-eraser"></i> Erase</a>
     <a href="#" class="btn green" onclick="crop_rect_button_click()"> <i class="fa fa-crop"></i> Crop</a>
     <!--<a href="#" class="btn green" onclick="zoom_button_click(0,0,2)"> <i class="fa fa-search-plus"></i> Zoom out</a>
     <a href="#" class="btn green" onclick="zoom_button_click(0,0,-2)"><i class="fa fa-search-minus"></i> Zoom in</a>-->
     <a href="#" class="btn green" onclick="drawOriginal()">           <i class="fa fa-reply"></i> Return</a>
</div>
<div id="lineMenu" class="submenu">
     <a href="#" class="btn red" onclick="draw_line_button_click()">         <i class="fa fa-pencil"></i> Draw</a>
     <a href="#" class="btn red" onclick="hideLine()">                       <i class="fa fa-retweet"></i> Hide</a>
     <a href="#" class="btn red" onclick="eraseLine()">                      <i class="fa fa-eraser"></i> Erase</a>
     <a href="#" class="btn red" onclick="selectObjects()">                  <i class="fa fa-map-marker"></i> Select</a>
     <a href="#" class="btn red" onclick="overlapping_lines_button_click()"> <i class="fa fa-refresh"></i> Matching</a>
</div>
<div id="workMenu" class="submenu">
     <a href="#" class="btn blue" onclick="upload_button_click()">         <i class="fa fa-upload"></i> Upload</a>
     <a href="#" class="btn blue" onclick="show_add_group_button_click()"> <i class="fa fa-plus-square"></i> Add group</a>
     <a href="#" class="btn blue" onclick="open_state_button_click()">     <i class="fa fa-folder-open-o"></i> Open project</a>
     <a href="#" class="btn blue" onclick="save_state_button_click()">     <i class="fa fa-floppy-o"></i> Save project</a>
</div>
<div id="filtersMenu" class="submenu">
    <a href="#" class="btn purple" onclick="applyNewFilters('EdgeDet')"> <i class="fa fa-play-circle"></i> Edge Detect</a>
    <a href="#" class="btn purple" onclick="applyNewFilters('Gray')">    <i class="fa fa-play-circle-o"></i> Grayscale</a>
    <a href="#" class="btn purple" onclick="removeFilters()">            <i class="fa fa-eraser"></i> Remove</a>
    <a href="#" class="btn purple" onclick="removeFiltersCanvas()">      <i class="fa fa-eraser"></i> Remove All</a>
</div>
</div>

<div id="group_name_input" class="group_name_input">
        <input type="text" id="textbox_group_name"></input>
        <i class="fa fa-plus" id="btn_add_group" onclick="add_group_button_click()"></i>
</div>

<div class="interface"><canvas id="interfaceCanvas" width="800" height="600"></canvas></div>

<div id="imageMenu" class="imageMenu">
    <div id="context_link"><a href="#" onclick="linkClick('-1');return false;">Main</a></div>
    <canvas id="imageMenuCanvas" width="800" height="600"></canvas>
    <canvas id="imageMenuCanvasBackground" width="800" height="600"></canvas>
    <i class="fa fa-times"           id="btn_imageMenu_hide" onclick="bt_imageMenu_hide()"></i>
</div>

<div class="show_imageMenu"           id="show_imageMenu_div">
	<i class="fa fa-caret-square-o-right" id="btn_imageMenu_show" onclick="bt_imageMenu_show()"></i>
</div>

<div class="lightbox" id="lightbox"><canvas id="lightboxCanvas" width="800" height="600"></canvas></div>

<div class="group_aux"><canvas id="auxiliarImageCanvas" width="100" height="100"></canvas></div>

<div class="file_open_list" id="file_open">
    <i class="fa fa-times" id="btn_close_open_state" onclick="btn_close_open_state_click()"></i>
    <table id="list_of_open_files">
    </table>
</div>

<div class="file_save_list" id="file_save">
    <i class="fa fa-times" id="btn_close_save_state" onclick="btn_close_save_state_click()"></i>
    <text id="label">File Name</text>
    <input type="text" id="textbox_file_name"></input>
    <i class="fa fa-floppy-o" id="btn_save_state" onclick="btn_save_state_click()"></i>
    <table id="list_of_files">
    </table>
</div>

<div class="metadata" id="metadata_div">
	<text>Annotations</text>
	<i class="fa fa-pencil-square-o" id="btn_metadata_edit" onclick="btn_metadata_edit_click()"></i>
	<i class="fa fa-floppy-o"        id="btn_metadata_save" onclick="btn_metadata_save_click()"></i>
    <i class="fa fa-times"           id="btn_metadata_hide" onclick="bt_metadata_hide()"></i>
	<br>
	<textarea id="textarea_metadata" rows="10" cols="40" disabled></textarea>
</div>

<div class="show_metadata"           id="show_metadata_div">
	<i class="fa fa-caret-square-o-left" id="btn_metadata_show" onclick="bt_metadata_show()"></i>
</div>

<div class="imageInteraction"  id="imageInteraction_div">
    <i class="fa fa-times"     id="btn_remove_image" onclick="btn_remove_image_click()"></i>
    <i class="fa fa-picture-o" id="btn_enlarge_image" onclick="btn_enlarge_image_click()"></i>
</div>
</body>


<script>
    /*$('#metadata_button').click(function () {
    alert('I am clickable');
});*/
    
    function bt_imageMenu_hide(){
        document.getElementById('imageMenu').style.visibility = 'hidden';
        document.getElementById('show_imageMenu_div').style.visibility = 'visible';
    }
    
    function bt_imageMenu_show(){
        document.getElementById('imageMenu').style.visibility = 'visible';
        document.getElementById('show_imageMenu_div').style.visibility = 'hidden';
    }

    function bt_metadata_hide(){
        document.getElementById('metadata_div').style.visibility = 'hidden';
        document.getElementById('show_metadata_div').style.visibility = 'visible';
    }

    function bt_metadata_show(){
        document.getElementById('metadata_div').style.visibility = 'visible';
        document.getElementById('show_metadata_div').style.visibility = 'hidden';
    }

    function toggleSubMenu(str){

        if(str != undefined){
            var m = document.getElementById(str);
        if(m.style.visibility === 'hidden')
            m.style.visibility = 'visible';
        else
            m.style.visibility = 'hidden';
        }

        var menus = ['lineMenu','rectMenu','workMenu', 'filtersMenu'];

        menus.forEach(function(d){
            if(d === str) return;
            document.getElementById(d).style.visibility = 'hidden';
        });
    }

    $("#btn_slide_menu").click(function() {
        $("#imageMenu").slideToggle(0);
    });
</script>

<script>
    fabric.RectLineImage = fabric.util.createClass(fabric.Image, {
        type: 'rectLineImage',
        zoomedXY: false,
        initialize: function(element, options)//(element, options)
        {
            options || (options = {});
            this.callSuper('initialize', element, options);
            this.set({
                orgSrc: element.src,
                old_left: this.left,
                old_top: this.top,
                old_width: this.width,
                old_height: this.height,
                old_angle: this.angle,
                rects: null,
                line: null,
                metadata: ""
            });
        },
        toObject : function()
        {
            //return fabric.util.object.extend(this.callSuper('toObject'), { rects: this.rects, line: this.line, metadata: this.metadata });
            return fabric.util.object.extend(this.callSuper('toObject'), {
                orgSrc: this.orgSrc,
                old_left: this.old_left,
                old_top: this.old_top,
                old_width: this.old_width,
                old_height: this.old_height,
                old_angle: this.old_angle,
                rects: this.rects,
                line: this.line,
                metadata: this.metadata
            });
        },
        updateRect: function(l, t, w, h) {
            this.rects.left = l;
            this.rects.top = t;
            this.rects.width = w;
            this.rects.height = h;
        },
        crop: function(l, t, w, h, callback){
            this.old_left = l;
            this.old_top = t;
            this.old_width = w;
            this.old_height = h;
            this.rerender(callback);
        },
        rerender: function(callback) {
            var img = new Image();
            var obj = this;
            img.onload = function() {
                var canvas = fabric.util.createCanvasElement();
                canvas.width  = obj.width;
                canvas.height = obj.height;

                canvas.getContext('2d').drawImage(this, obj.old_left, obj.old_top, obj.old_width, obj.old_height, 0, 0, obj.width, obj.height);

                img.onload = function() {
                    obj.setElement(this);
                    //obj.applyFilters(mycanvas.renderAll.bind(mycanvas));
                    obj.set({
                        left: obj.left,
                        top: obj.top,
                        angle: obj.angle
                    });
                    obj.setCoords();
                    if (callback) { callback(obj); }
                };
                img.src = canvas.toDataURL('image/png');
            };
            img.src = this.orgSrc;
        }
    });

    fabric.RectLineImage.async = true;

    fabric.RectLineImage.fromObject = function(object, callback) {
        var temp;
        fabric.util.loadImage(object.src, function(img) {
            temp = new fabric.RectLineImage(img, object);
            temp.orgSrc = object.orgSrc;
            temp.old_left = object.old_left;
            temp.old_top = object.old_top;
            temp.old_width = object.old_width;
            temp.old_height = object.old_height;
            temp.old_angle = object.old_angle;
            //if (object.rects != null)
            //	attach(object.rects, temp);
            temp.rects = object.rects;
            temp.line = object.line;
            temp.metadata = object.metadata;
            callback && callback(temp);
        });
        /*fabric.util.loadImage(object.src, function(img) {
            fabric.Image.prototype._initFilters.call(object, object, function(filters) {
                object.filters = filters || [];
                var instance = new fabric.RectLineImage(img, object);
                if (callback) { callback(instance); }
            });
        }, null, object.crossOrigin);*/
        /*fabric.util.enlivenObjects(object.objects, function (enlivenedObjects) {
            delete object.objects;
            callback && callback(new fabric.RectLineImage(enlivenedObjects, object));
        });*/
    };

    fabric.Image.filters.EdgeCanny = fabric.util.createClass(fabric.Image.filters.BaseFilter, {
                type: 'Canny',
                initialize: function (options) {
                },
                applyTo: function (canvasEl) {
                    var context = canvasEl.getContext('2d'),
                            imagedata = context.getImageData(0, 0, canvasEl.width, canvasEl.height),
                            data = imagedata.data;

                    var img_u8 = new jsfeat.matrix_t(canvasEl.width, canvasEl.height, jsfeat.U8_t | jsfeat.C1_t);

                    var blur_radius = 2;
                    var low_threshold = 20;
                    var high_threshold = 50;

                    jsfeat.imgproc.grayscale(data, canvasEl.width, canvasEl.height, img_u8);

                    var r = blur_radius|0;
                    var kernel_size = (r+1) << 1;

                    jsfeat.imgproc.gaussian_blur(img_u8, img_u8, kernel_size, 0);

                    jsfeat.imgproc.canny(img_u8, img_u8, low_threshold|0, high_threshold|0);

                    // render result back to canvas
                    var data_u32 = new Uint32Array(data.buffer);
                    var alpha = (0xff << 24);
                    var i = img_u8.cols*img_u8.rows, pix = 0;

                    while(--i >= 0) {
                      pix = img_u8.data[i];
                        data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                    }

                    context.putImageData(imagedata, 0,0);
                }
            });

    fabric.Image.filters.GrayScale = fabric.util.createClass(fabric.Image.filters.BaseFilter, {
                type: 'Canny',
                initialize: function (options) {
                },
                applyTo: function (canvasEl) {
                    var context = canvasEl.getContext('2d'),
                            imagedata = context.getImageData(0, 0, canvasEl.width, canvasEl.height),
                            data = imagedata.data;

                    var img_u8 = new jsfeat.matrix_t(canvasEl.width, canvasEl.height, jsfeat.U8_t | jsfeat.C1_t);

                    jsfeat.imgproc.grayscale(data, canvasEl.width, canvasEl.height, img_u8);

                    // render result back to canvas
                    var data_u32 = new Uint32Array(data.buffer);
                    var alpha = (0xff << 24);
                    var i = img_u8.cols*img_u8.rows, pix = 0;

                    while(--i >= 0) {
                      pix = img_u8.data[i];
                        data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                    }

                    context.putImageData(imagedata, 0,0);
                }
            });

    var filter = new fabric.Image.filters.Sepia2({
        sepia: 0
    });
</script>

<script>
    function Group(name) {
        this.name = name;
        this.images = new Array;
        //this.thumbnail = new Image();
        //console.log(this.thumbnail);
        this.getThumbnail = function() {
            var auxiliarImageCanvas = document.getElementById('auxiliarImageCanvas');
            var auxiliarImageContext = auxiliarImageCanvas.getContext('2d');

            auxiliarImageContext.clearRect( 0 , 0 , auxiliarImageCanvas.width, auxiliarImageCanvas.height );
            auxiliarImageContext.font = "20px Georgia";
            auxiliarImageContext.textAlign = "center";
            auxiliarImageContext.fillStyle = "#ffffff";
            auxiliarImageContext.fillText(this.name, auxiliarImageCanvas.width/2, 20, auxiliarImageCanvas.width);

            if (this.images.length > 0)
            {

            }

            //this.thumbnail.src = auxiliarImageCanvas.toDataURL();
            //this.thumbnail.onload = function(){
            //    console.log(this.thumbnail);
            //    callback();
            //}
            return auxiliarImageCanvas;
        };
    }
</script>

<script>
    var interfaceCanvas = document.getElementById('interfaceCanvas');
    var interfaceContext = interfaceCanvas.getContext('2d');

    var imageMenuCanvas = document.getElementById('imageMenuCanvas');
    var imageMenuContext = imageMenuCanvas.getContext('2d');

    var lightboxCanvas = new fabric.Canvas('lightboxCanvas');
    var lightboxCanvasContext = imageMenuCanvas.getContext('2d');

    var current_menu_workspace;
    var workspace_hierarchy = "-1";

    var alpha = 0.5;
    var number_of_columns = 3;
    var marginx;
    var marginy;
    var offsetx;

    var selected_image = -1;
    var drag = false;
    var image_name_list = "{{=image_list}}";

    if (image_name_list.length > 0) {
        image_name_list = image_name_list.split(" ");
    }

    var loadingState;
    var width_scale;
    var height_scale;

    function getMousePosition(canvas, event) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: event.pageX - rect.left,
            y: event.pageY - rect.top
        };
    }

    function isImage(element) {
        if (Object.prototype.toString.call(element).slice(8, -1) == 'HTMLImageElement')
        {
            return true;
        }

        return false;
    }

    function getMenuStateData(workspace) {
        var result = "";

        for (var i=0; i < workspace.length; i++)
        {
            if (isImage(workspace[i]))
            {
                temp = workspace[i].src;
                temp = temp.split("/");
                result = result + temp[temp.length - 1].substring(0, temp[temp.length - 1].length - 4) + "\n";
            }
            else
            {
                result = result + "\\" + workspace[i].name + "\n" + getMenuStateData(workspace[i].images) + "\\" + workspace[i].name + "\n";
            }
        }

        return result;
    }

    function getStateData(workspace) {
        var temp;
        var result = "\\menu\n";
        var canvas_backup = lightboxCanvas;

        lightboxCanvas.forEachObject(function (obj) {
            if (obj instanceof fabric.RectLineImage) return;
            lightboxCanvas.remove(obj);
        });

        result = result + getMenuStateData(workspace);

        result = result + "\\menu\n";
        result = result + "\\lightbox\n";
        result = result + JSON.stringify(lightboxCanvas) + "\n";
        result = result + "\\lightbox\n";

        lightboxCanvas = canvas_backup;
        lightboxCanvas.renderAll();

        return result;
    }

    function loadGroup(group, content, state) {
        group.name = content[0];

        for (var i = 1; i < content.length; i++)
        {
            if (content[i].constructor === Array)
            {
                group.images.push(new Group);
                loadGroup(group.images[group.images.length - 1], content[i], loadingState);
            }
            else
            {
                group.images.push(' ');
                loadingState.push({'group': group.images, 'imagesrc': "../static/images/user/" + content[i] + ".png", index: i-1});
            }
        }
    }

    function loadStateData(content) {
        main_menu_workspace = [];
        loadingState = new Array();
        editableImageArray = new Array();

        for (var i = 0; i < content.length - 1; i++)
        {
            if (content[i].constructor === Array)
            {
                main_menu_workspace.push(new Group);
                loadGroup(main_menu_workspace[main_menu_workspace.length - 1], content[i], loadingState);
            }
            else
            {
                main_menu_workspace.push('');
                loadingState.push({'group': main_menu_workspace, 'imagesrc': "../static/images/user/" + content[i] + ".png", index: i});
            }
        }

        $('#context_link').empty();
        workspace_hierarchy = "-1";
        $('#context_link').append("<a href='#' onclick='linkClick(\"-1\");return false;'>Main</a>");
        lightboxCanvas.clear();
        lightboxCanvas.loadFromJSON(content[content.length - 1], lightboxCanvas.renderAll.bind(lightboxCanvas), function (o, object) {
            var temp;
            if (object.rects != null)
            {
                temp = object.rects;
                attach(temp, object);
                lightboxCanvas.add(object.rects).renderAll();
                object.rects.bringToFront();
            }
            if (object.line != null)
            {
                temp = object.line;
                object.line = new fabric.Line([temp.x1, temp.y1, temp.x2, temp.y2], {
                    strokeWidth: temp.strokeWidth,
                    stroke: temp.stroke,
                    originX: temp.originX,
                    originY: temp.originY
                });
                lightboxCanvas.add(object.line).renderAll();
                object.line.bringToFront();
            }
        });

        loadImagesState(loadingState, imageLoaded);
    }

    function resizeCanvas() {
        $('#imageMenu').width((window.innerWidth - (window.innerWidth * 0.03)) * 0.3 + 17);
        $('#imageMenu').height(window.innerHeight * 0.95);
        imageMenuCanvas.width = (window.innerWidth - (window.innerWidth * 0.03)) * 0.3;
        imageMenuCanvas.height = (window.innerHeight - (window.innerHeight * 0.03));
        //$('#imageMenu').scrollTop($('#imageMenu')[0].scrollHeight);
        $('#imageMenuCanvasBackground').width(imageMenuCanvas.width);
        $('#imageMenuCanvasBackground').height(imageMenuCanvas.height);

        marginx = imageMenuCanvas.width * 0.016;
        marginy = marginx;//imageMenuCanvas.height * 0.025;
        offsetx = imageMenuCanvas.width * 0.3;//imageMenuCanvas.width * 0.08;

        width_scale = window.innerWidth / 3;
        height_scale = imageMenuCanvas.height / 3;

        var auxiliarImageCanvas = document.getElementById('auxiliarImageCanvas');
        auxiliarImageCanvas.width = offsetx;
        auxiliarImageCanvas.height = offsetx;

        lightboxCanvas.setWidth(window.innerWidth);
        lightboxCanvas.setHeight(imageMenuCanvas.height);

        interfaceCanvas.width = lightboxCanvas.getWidth();
        interfaceCanvas.height = lightboxCanvas.getHeight();

        $("#file_save").css("width", window.innerWidth);
        $("#file_save").css("height", window.innerHeight);
        $("#file_open").css("width", window.innerWidth);
        $("#file_open").css("height", window.innerHeight);
        //var fileListBackgroundCanvas = document.getElementById('file_list_background');
        //fileListBackgroundCanvas.width = window.innerWidth;
        //fileListBackgroundCanvas.height = window.innerHeight;
        /*imageMenuContext.globalAlpha = alpha;
		imageMenuContext.fillStyle = "#777777";
		imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
        imageMenuContext.globalAlpha = 1;*/
    }

    resizeCanvas();

    function resizeImageMenu() {
        if (marginy + (Math.floor(current_menu_workspace.length/3) + 1) * (2 * marginy + offsetx) > imageMenuCanvas.height)
        {
            imageMenuCanvas.height = marginy + (Math.floor(current_menu_workspace.length/3) + 1) * (2 * marginy + offsetx);
        }
        else
        {
            if (marginy + (Math.floor(current_menu_workspace.length/3) + 1) * (2 * marginy + offsetx) <= window.innerHeight * 0.95)
                imageMenuCanvas.height = window.innerHeight * 0.95;
            else
                imageMenuCanvas.height = marginy + (Math.floor(current_menu_workspace.length/3) + 1) * (2 * marginy + offsetx);
        }
    }

    function img(source) {
        this.data = new Image();
        this.data.src = source;
        this.data.onload = function() {
            this.width = this.data.width;
            this.height = this.data.height;
        }
        this.draw = function(x, y, sizex, sizey) {
            imageMenuContext.drawImage(this.data, x, y, sizex, sizey);
        }
        //    context.drawImage(imageObj, marginx + (marginx * 2 * i) + (offsetx * i), marginy, offsetx, (offsetx / this.width) * this.height);
    }

    var editableImageArray = new Array;
    var imageArray = [];
    var main_menu_workspace = [];
    current_menu_workspace = main_menu_workspace;

    for (var i = 0; i<image_name_list.length; i++) {
        imageArray.push("../static/images/user/" + image_name_list[i]);
    }
    //editableImageArray[0] = fabric.Image.fromURL(imageArray[2], function(loaded_img) { lightboxCanvas.add(loaded_img); });
    //editableImageArray[0] = fabric.Image.fromURL('../static/images/user/2.png', function(loaded_img) { lightboxCanvas.add(loaded_img); });

    function loadImagesState(array, callBack) {
        var count = 0;
        var temp_image;
        var index;

        for (var i in array) {
            temp_image = new Image();
            temp_image.src = array[i]['imagesrc'];
            array[i]['group'][array[i]['index']] = temp_image;
            index = array[i]['index'];
            array[i]['group'][index].onload = function(){
                count++;
                if (count == array.length){
                    current_menu_workspace = main_menu_workspace;
                    callBack();
                }
            }
        }
    }

    function loadImages(arr, callBack){
        var count = 0;

        for (var i in arr ){
            current_menu_workspace[i] = new Image();
            current_menu_workspace[i].src = arr[i];
            current_menu_workspace[i].onload = function(){
                count++;
                if(count == arr.length){
                    callBack(current_menu_workspace);
                }
            }
        }
    }

    function imageLoaded() {
        var offsety;
        var temp;
        var img_width, img_height;

        resizeImageMenu();
        imageMenuContext.clearRect( 0 , 0 , imageMenuCanvas.width, imageMenuCanvas.height );

        for (var i in current_menu_workspace) {
            offsety = 0;
            temp = i - number_of_columns + 1;
            while (temp > 0) {
                //offsety = offsety + (marginy * 2) + ((offsetx / img[temp-1].width) * img[temp-1].height);
                offsety = offsety + (marginy * 2) + offsetx;
                temp = temp - number_of_columns;
            }
            //context.drawImage(img[i], marginx + (marginx * 2 * (i % number_of_columns)) + (offsetx * (i % number_of_columns)), marginy + offsety, offsetx, (offsetx / img[i].width) * img[i].height);
            if (current_menu_workspace[i].width > current_menu_workspace[i].height)
            {
                img_width = offsetx;
                img_height = (offsetx / current_menu_workspace[i].width) * current_menu_workspace[i].height;
                img_height = (offsetx / current_menu_workspace[i].width) * current_menu_workspace[i].height;
            }
            else
            {
                img_width = (offsetx / current_menu_workspace[i].height) * current_menu_workspace[i].width;
                img_height = offsetx;
            }
            if (Object.prototype.toString.call(current_menu_workspace[i]).slice(8, -1) == 'HTMLImageElement')
            {
                imageMenuContext.drawImage(current_menu_workspace[i], marginx + (marginx * 2 * (i % number_of_columns)) + (offsetx * (i % number_of_columns)) + ((offsetx - img_width) / 2), marginy + offsety + ((offsetx - img_height) / 2), img_width, img_height);
                //imageMenuContext.rect((marginx * 2 * (i % number_of_columns)) + (offsetx * (i % number_of_columns)), offsety, offsetx + (marginx * 2), offsetx + (marginy * 2));
            }
            else
            {
                img_width = offsetx;
                img_height = offsetx;
                imageMenuContext.drawImage(current_menu_workspace[i].getThumbnail(), marginx + (marginx * 2 * (i % number_of_columns)) + (offsetx * (i % number_of_columns)) + ((offsetx - img_width) / 2), marginy + offsety + ((offsetx - img_height) / 2), img_width, img_height);
            }
        }
        imageMenuContext.stroke();
    }

    loadImages(imageArray, imageLoaded);

    function getImageMouseCollision(mousepos) {
        var result = -1;
        var temp = -1;
        for (var i = 1; i<number_of_columns+1; i++)
        {
            if (mousepos.x < i * (offsetx + 2 * marginx))
            {
                temp = i - 1;
                break;
            }
        }

        if (temp > -1)
        {
            var offsety = 0;
            var i;
            for (i = temp; i<current_menu_workspace.length; i = i + number_of_columns)
            {
                //width = (marginy * 2) + ((offsetx / img[i].width) * img[i].height);
                width = (marginy * 2) + offsetx;
                if (mousepos.y >= offsety && mousepos.y < offsety + width)
                {
                    result = i;
                    break;
                }
                offsety = offsety + width;
            }
            if (i >= current_menu_workspace.length)
            {
                result = -1;
            }
        }
        else
        {
            result = -1;
        }

        return result;
    }

    function mouseDownEvent(e) {
        var mousepos = getMousePosition(imageMenuCanvas, e);

        selected_image = getImageMouseCollision(mousepos);
        if (selected_image > -1)
        {
            drag = true;
            interfaceCanvas.style.zIndex = 10;
        }
    }

    function mouseMoveImageMenuEvent(e) {
        var mousePosition = getMousePosition(imageMenuCanvas, e);
        var image_index = getImageMouseCollision(mousePosition);

        var positionX = (offsetx + 2 * marginx) * ((image_index % 3) + 1);
        var positionY = marginy + (offsetx + 2 * marginy) * (Math.floor(image_index / 3));

        hovering_obj = image_index;

        $('#btn_remove_image').show();
        $('#btn_enlarge_image').hide();

        $('#btn_remove_image').offset({top: $('#imageMenuCanvas').offset().top + positionY + $('#btn_remove_image').height() - 10, left: positionX - $('#btn_remove_image').width() - 10});
    }

    function mouseOutImageMenuEvent(e) {
        var mousePosition = getMousePosition(imageMenuCanvas, e);
        var imageIndex = getImageMouseCollision(mousePosition);

        if (imageIndex == -1)
        {
            $('#btn_remove_image').hide();
            hovering_obj = null;
        }
    }

    function mouseRightClickEvent(e) {
        var mousepos = getMousePosition(imageMenuCanvas, e);

        e.preventDefault();

        selected_image = getImageMouseCollision(mousepos);
        if (selected_image > -1)
        {
            if (Object.prototype.toString.call(current_menu_workspace[selected_image]).slice(8, -1) != 'HTMLImageElement')
            {
                workspace_hierarchy = workspace_hierarchy + "/" + selected_image;
                $('#context_link').append(" > <a href='#' onclick='linkClick(\"" + workspace_hierarchy + "\");return false;'>" + current_menu_workspace[selected_image].name + "</a>");
                current_menu_workspace = current_menu_workspace[selected_image].images;
                imageLoaded();
            }
        }
    }

    function mouseMoveEvent(e) {
        if (drag)
        {
            //drawScreenWithRect(getMousePosition(imageMenuCanvas, e), false);
            drawScreenWithRect(getMousePosition(interfaceCanvas, e), false);
        }
    }

    function mouseUpEvent(e) {
        if (drag)
        {
            drag = false;

            var mousePosition = getMousePosition(imageMenuCanvas, e);
            //console.log(getMousePosition(imageMenuCanvas, e));
            var drop_image = getImageMouseCollision(mousePosition);
            if (drop_image > -1 && drop_image != selected_image)
            {
                if (Object.prototype.toString.call(current_menu_workspace[drop_image]).slice(8, -1) == 'HTMLImageElement')
                {
                    var temp_image = current_menu_workspace[selected_image];
                    current_menu_workspace[selected_image] = current_menu_workspace[drop_image];
                    current_menu_workspace[drop_image] = temp_image;
                }
                else
                {
                    current_menu_workspace[drop_image].images.push(current_menu_workspace[selected_image]);
                    current_menu_workspace.splice($.inArray(current_menu_workspace[selected_image], current_menu_workspace), 1);

                    imageLoaded();
                }
            }
            else if (drop_image = -1)
            {
                if (Object.prototype.toString.call(current_menu_workspace[selected_image]).slice(8, -1) == 'HTMLImageElement')
                {
                    /*editableImageArray.push(new fabric.Image.fromURL(current_menu_workspace[selected_image].src, function(loaded_img) {
                        loaded_img.set('left', mousePosition.x - (loaded_img.getWidth() / 2)).set('top', mousePosition.y - (loaded_img.getHeight() / 2));
                        lightboxCanvas.add(loaded_img);
                    }));*/
                    mousePosition = getMousePosition(interfaceCanvas, e);
                    var ratio = 1.0;
                    if (current_menu_workspace[selected_image].width > current_menu_workspace[selected_image].height)
                    {
                        if (current_menu_workspace[selected_image].width > width_scale)
                        {
                            ratio = width_scale / current_menu_workspace[selected_image].width;
                        }
                    }
                    else
                    {
                        if (current_menu_workspace[selected_image].height > height_scale)
                        {
                            ratio = height_scale / current_menu_workspace[selected_image].height;
                        }
                    }
                    editableImageArray.push(new fabric.RectLineImage(current_menu_workspace[selected_image], {
                        left: mousePosition.x - (current_menu_workspace[selected_image].width * ratio / 2),//(loaded_img.getWidth() / 2),
                        top: mousePosition.y - (current_menu_workspace[selected_image].height * ratio / 2)//(loaded_img.getHeight() / 2)
                    }));
                    editableImageArray[editableImageArray.length - 1].set({scaleX: ratio, scaleY: ratio});
                    lightboxCanvas.add(editableImageArray[editableImageArray.length - 1]);
                    editableImageArray[editableImageArray.length - 1].setCoords();
                }
            }

            drawScreenWithRect(getMousePosition(interfaceCanvas, e), true);
        }
        interfaceContext.clearRect(0, 0, interfaceCanvas.width, interfaceCanvas.height);
        interfaceCanvas.style.zIndex = -1;
    }

    function linkClick(link) {
        $('#context_link').empty();
        workspace_hierarchy = "-1";
        $('#context_link').append("<a href='#' onclick='linkClick(\"-1\");return false;'>Main</a>");

        if (link == "-1")
        {
            current_menu_workspace = main_menu_workspace;
        }
        else
        {
            path = link.split('/');
            for (var i = 0; i < path.length; i++)
            {
                if (parseInt(path[i]) < 0)
                {
                    current_menu_workspace = main_menu_workspace;
                }
                else
                {
                    workspace_hierarchy = workspace_hierarchy + '/' + path[i];
                    $('#context_link').append(" > <a href='#' onclick='linkClick(\"" + workspace_hierarchy + "\");return false;'>" + current_menu_workspace[parseInt(path[i])].name + "</a>");
                    current_menu_workspace = current_menu_workspace[parseInt(path[i])].images;
                }
            }
        }
        imageLoaded();
    }

    imageMenuCanvas.onmousedown = mouseDownEvent;
    //imageMenuCanvas.oncontextmenu = mouseRightClickEvent;
    imageMenuCanvas.addEventListener('mousemove', mouseMoveImageMenuEvent, false);
    imageMenuCanvas.addEventListener('mouseout', mouseOutImageMenuEvent, false);
    imageMenuCanvas.addEventListener('contextmenu', mouseRightClickEvent, false);
    //imageMenuCanvas.onmousemove = mouseMoveEvent;
    //imageMenuCanvas.onmouseup = mouseUpEvent;
    interfaceCanvas.onmousemove = mouseMoveEvent;
    interfaceCanvas.onmouseup = mouseUpEvent;

    function drawScreenWithRect(mousepos, erase) {
        //imageMenuContext.clearRect( 0 , 0 , imageMenuCanvas.width, imageMenuCanvas.height );
        /*imageMenuContext.fillStyle = "#ffffff";
        imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
        imageMenuContext.globalAlpha = alpha;
        imageMenuContext.fillStyle = "#777777";
        imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
        imageMenuContext.globalAlpha = 1;*/

        imageLoaded();

        if (!erase) {
            interfaceContext.clearRect( 0 , 0 , interfaceCanvas.width, interfaceCanvas.height );
            interfaceContext.fillStyle = "#0000ff"
            interfaceContext.fillRect(mousepos.x - 10, mousepos.y - 10, 20, 20);
            //imageMenuContext.fillStyle = "#0000ff";
            //imageMenuContext.fillRect(mousepos.x - 10, mousepos.y - 10, 20, 20);
        }
    }

    function upload_button_click() {
        $('#images').click();
    }

    function show_add_group_button_click() {
        if ($('#group_name_input').css("visibility") == "hidden")
        {
            $('#group_name_input').css("visibility","visible");
        }
        else
        {
            $('#group_name_input').css("visibility","hidden");
            $('#textbox_group_name').val("");
        }
    }

    function add_group_button_click() {
        if ($('#textbox_group_name').val() != "")
        {
            current_menu_workspace.push(new Group($('#textbox_group_name').val()));
            $('#textbox_group_name').val("");
            $('#group_name_input').css("visibility","hidden");

            /*imageMenuContext.fillStyle = "#ffffff";
            imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
            imageMenuContext.globalAlpha = alpha;
            imageMenuContext.fillStyle = "#777777";
            imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
            imageMenuContext.globalAlpha = 1;*/
            imageLoaded();
        }
    }

    function open_state_button_click() {
        $.get("state_list", function( data ) {
            var filenames = JSON.parse(data);

            $('#list_of_open_files').html("<tr><th>File</th><th>Date</th></tr>");
            for (var i = 0; i < filenames.length; i++)
            {
                $('#list_of_open_files').append("<tr class=\"row\"><td><i class=\"fa fa-file-o\"></i> " + filenames[i][0] + "</td><td style=\"text-align: center;\">" + filenames[i][1] + "</td></tr>");
            }

            var rows = $('.row');

            rows.on('click', function(e) {
                var row = $(this);

                rows.removeClass('highlight');
                row.addClass('highlight');
                //console.log(row.text());
                //$('#file_name').text(row.text());
            });

            rows.on('dblclick', function(e) {
                var row = $(this);
                var content = row.html();
                var filename;

                content = content.split('</i> ');
                filename = (content[1].split('</td>'))[0];

                $.ajax({
                    url: "{{=URL('default', 'open_state')}}",
                    type: "POST",
                    data: "filename=" + JSON.stringify(filename),
                    success: function (data)
                    {
                        var content = JSON.parse(data);
                        loadStateData(content);
                        btn_close_open_state_click();
                    },
                    error: function (data)
                    {
                        console.log(data.responseText);
                    }
                });
            });

            $('#file_open').css("visibility", "visible");
            $('#file_open').css("z-index", "6");
        });
    }

    function save_state_button_click() {
        $.get("state_list", function( data ) {
            var filenames = JSON.parse(data);

            $('#list_of_files').html("<tr><th>File</th><th>Date</th></tr>");
            for (var i = 0; i < filenames.length; i++)
            {
                $('#list_of_files').append("<tr><td><i class=\"fa fa-file-o\"></i> " + filenames[i][0] + "</td><td style=\"text-align: center;\">" + filenames[i][1] + "</td></tr>");
            }

            $('#file_save').css("visibility", "visible");
            $('#file_save').css("z-index", "6");
        });
    }

    function handleFileSelect(evt) {
        var images = evt.target.files;

        for (var i = 0, temp_img; temp_img = images[i]; i++) {
            var reader = new FileReader();

            reader.onload = (function(image) {
                return function(e) {
                    //console.log('1');
                    var result = encodeURIComponent(e.target.result.match(/,(.*)$/)[1]);
                    //console.log(' 2');
                    $.ajax({
                        url: "{{=URL('default', 'upload')}}",
                        type: "POST",
                        data: "data=" + JSON.stringify(result),
                        success: function (data)
                        {
                            imageArray.push("../static/images/user/" + data);
                            current_menu_workspace.push(new Image());
                            current_menu_workspace[current_menu_workspace.length - 1].src = imageArray[imageArray.length - 1];
                            current_menu_workspace[current_menu_workspace.length - 1].onload = function(){
                                imageMenuContext.fillStyle = "#ffffff";
                                imageMenuContext.fillRect(0, 0, imageMenuCanvas.width, imageMenuCanvas.height);
                                imageLoaded();
                            }
                            //console.log(data);
                        },
                        error: function (data)
                        {
                            //console.log(data.responseText);
                        }
                    });
                    //console.log('  3');
                };
            })(temp_img);

            reader.readAsDataURL(temp_img);
        }
    }

    document.getElementById('images').addEventListener('change', handleFileSelect, false);

    function btn_save_state_click() {
        if ($('#textbox_file_name').val() != "")
        {
            $.ajax({
                url: "{{=URL('default', 'save_state')}}",
                type: "POST",
                data: "data=" + JSON.stringify(getStateData(main_menu_workspace)) + "&filename=" + $('#textbox_file_name').val(),
                success: function (data)
                {
                    $('#file_save').css("visibility", "hidden");
                    $('#file_save').css("z-index", "-2");
                    $('#textbox_file_name').val("");
                },
                error: function (data)
                {
                    //console.log(data.responseText);
                }
            });
        }
    }

    function btn_close_open_state_click() {
        $('#file_open').css("visibility", "hidden");
        $('#file_open').css("z-index", "-2");
    }

    function btn_close_save_state_click() {
        $('#file_save').css("visibility", "hidden");
        $('#file_save').css("z-index", "-2");
        $('#textbox_file_name').val("");
    }

    // From here - Lhaylla
    // ADDON

    lightboxCanvas.on({'object:moving'  : onChange,
        'object:scaling' : onChange,
        'object:rotating': onRotating,
        'object:selected': onSelect});

    function isIn(rect, image) {
        if(rect === image) return false;
        if(rect.isContainedWithinObject(image)) return true;
        return false;
    }

    function attach(rect, image){
        image.rects = new fabric.Rect({
            left:            rect.left,
            top:             rect.top,
            width:           rect.width,
            height:          rect.height,
            angle:           0,
            fill:            'transparent',
            stroke:          '#000000',
            strokeDashArray: [3, 2],
            strokeWidth:     2,
            hasBorders:      false,
            selectable:      false
        });
    }

    function draw_rect_button_click() {
        var isDown;
        var pointer;
        var origX, origY, finX, finY;

        var temp_rect = new fabric.Rect({
            fill: 'transparent',
            stroke: '#000000',
            strokeDashArray: [3, 2],
            strokeWidth: 2,
            hasBorders: false
        });

        lightboxCanvas.add(temp_rect);
        lightboxCanvas.forEachObject(function (obj) {
            obj.selectable = false;
        });

        lightboxCanvas.on('mouse:down', function (event) {
            isDown = true;

            pointer = lightboxCanvas.getPointer(event.e);
            origX = pointer.x;
            origY = pointer.y;
            temp_rect.set({left: origX, top: origY, width: 0, height: 0});
        });

        lightboxCanvas.on('mouse:move', function (event) {
            if (!isDown) return;

            pointer = lightboxCanvas.getPointer(event.e);
            finX = pointer.x;
            finY = pointer.y;

            if (origX > finX) temp_rect.set({left: Math.abs(finX)});
            if (origY > finY) temp_rect.set({top: Math.abs(finY)});

            temp_rect.set({width: Math.abs(origX - finX), height: Math.abs(origY - finY)});
            temp_rect.setCoords();
            lightboxCanvas.renderAll();
        });


        lightboxCanvas.on('mouse:up', function (event) {
            isDown = false;

            lightboxCanvas.forEachObject(function (obj) {

                if(obj instanceof fabric.Image) obj.selectable = true;

                if (isIn(temp_rect, obj)) {
                    attach(temp_rect, obj);
                    obj.set({old_left:   obj.oCoords.tl.x,
                        old_top:    obj.oCoords.tl.y,
                        old_width:  obj.getWidth(),
                        old_height: obj.getHeight(),
                        old_angle:  obj.getAngle()
                    });

                    lightboxCanvas.add(obj.rects);
                    obj.rects.bringToFront();
                }
            });

            lightboxCanvas.remove(temp_rect);
            lightboxCanvas.off({'mouse:down': null, 'mouse:move': null, 'mouse:up': null});
            lightboxCanvas.renderAll();
        });
    }

    function hideRect(){
        lightboxCanvas.forEachObject(function (obj) {
            if(obj instanceof fabric.Image)
                obj.rects.visible = !obj.rects.visible;
        });

        lightboxCanvas.renderAll();
    }

    function eraseRect(){

        lightboxCanvas.forEachObject(function (obj) {
            lightboxCanvas.remove(obj.rects);
            obj.rects = null;
        });

        croped_images.length = 0;
        croped_images2.length = 0;
        croped_images3.length = 0;
        lightboxCanvas.renderAll();
    }

    var croped_images = new Array(), croped_images2 = new Array(), croped_images3 = new Array();

    function crop_rect_button_click() {

        var ratio = 1.0;
        var width_ratio = 1.0, height_ratio = 1.0;
        var count = 0;

        lightboxCanvas.deactivateAll();
        lightboxCanvas.forEachObject(function (obj) {
            obj.visible = false;
            if (obj instanceof fabric.Rect)
            {
                if (obj.width > 0)
                {
                    count = count + 1;
                }
            }
        });

        width_ratio = (lightboxCanvas.width - (10 * (count + 1)));
        if (count == 2) width_ratio = width_ratio / 2;
        else if (count > 2) width_ratio = width_ratio / Math.ceil(count / 2);

        //height_ratio = ((lightboxCanvas.height  - (10 * (count + 1))) / (count > 2 ? 2:1));
        height_ratio = ((lightboxCanvas.height - (40 + (count > 2 ? 20 : 10))) / (count > 2 ? 2 : 1));

        var index = 1;

        lightboxCanvas.forEachObject(function (obj) {
            if (obj instanceof fabric.RectLineImage)
            {
                if (obj.rects.width > 0)
                {
                    ratio = width_ratio / obj.rects.width;
                    if (ratio > height_ratio / obj.rects.height)
                    {
                        ratio = height_ratio / obj.rects.height;
                    }

                    var temp_img = new Image();
                    temp_img.src = obj.getSrc();

                    var left = 10;
                    if (count > 1)
                        left = left + ((10 + width_ratio) * (index % (Math.ceil(count/2) == 1 ? 2 : Math.ceil(count/2))));
                    left = left + ((width_ratio - (obj.rects.width * ratio)) / 2);

                    var top = 10;
                    if (count > 2)
                    {
                        if (index > Math.ceil(count / 2))
                        {
                            top = top + 10 + height_ratio;
                        }
                    }
                    top = top + ((height_ratio - (obj.rects.height * ratio)) / 2);

                    temp_img.onload = function()
                    {
                        croped_images.push(obj);
                        croped_images2.push(new fabric.RectLineImage(temp_img, {
                            originX: 'left',
                            originY: 'top',
                            left:    left,
                            top:     top,
                            width:   obj.rects.width  * ratio,
                            height:  obj.rects.height * ratio
                        }));

                        var i = croped_images2.length - 1;

                        croped_images2[i].crop((obj.rects.left - obj.left) / obj.scaleX,
                                (obj.rects.top  - obj.top)  / obj.scaleY,
                                obj.rects.width  / obj.scaleX,
                                obj.rects.height / obj.scaleY,
                                function() { lightboxCanvas.renderAll() });

                        lightboxCanvas.add(croped_images2[i]);
                        croped_images2[i].selectable = false;
                        croped_images2[i].controls = false;

                        croped_images3.push(new fabric.RectLineImage(temp_img, {
                            originX: 'right',
                            originY: 'bottom',
                            left:    left + croped_images2[i].width,
                            top:     top  + croped_images2[i].height
                        }));

                        croped_images3[i].set({scaleX: 0.2 * obj.rects.height * ratio / croped_images[i].height,
                            scaleY: 0.2 * obj.rects.height * ratio / croped_images[i].height});
                        lightboxCanvas.add(croped_images3[i]);
                        croped_images3[i].bringToFront();
                        croped_images3[i].selectable = false;
                        croped_images3[i].controls = false;

                        var left3 = croped_images3[i].oCoords.tl.x + ((obj.rects.left - obj.left) / obj.scaleX) * croped_images3[i].scaleX;
                        var top3  = croped_images3[i].oCoords.tl.y + ((obj.rects.top  - obj.top)  / obj.scaleY) * croped_images3[i].scaleY;
                        var wid3  = (obj.rects.width  / obj.scaleX) * croped_images3[i].scaleX;
                        var hei3  = (obj.rects.height / obj.scaleY) * croped_images3[i].scaleY;

                        croped_images3[i].rects = new fabric.Rect({
                            left:            left3,
                            top:             top3,
                            width:           wid3,
                            height:          hei3,
                            fill:            'transparent',
                            stroke:          '#000000',
                            strokeDashArray: [3, 2],
                            strokeWidth:     2,
                            hasBorders:      false,
                            selectable:      false
                        });


                        lightboxCanvas.add(croped_images3[i].rects);
                        croped_images3[i].rects.bringToFront();

                    }
                    index = index + 1;
                }
            }
            initKeyboard();
        });

        lightboxCanvas.forEachObject(function (obj) {
            obj.selectable = false;
        });

        var isDown;

        lightboxCanvas.on('mouse:down', function (event) {
            isDown = true;
            pointer = lightboxCanvas.getPointer(event.e);
            origX = pointer.x;
            origY = pointer.y;
        });

        lightboxCanvas.on('mouse:move', function (event) {
            if (!isDown) return;

            var pointer = lightboxCanvas.getPointer(event.e);
            finX = pointer.x;
            finY = pointer.y;

            //drag_croped_image((finX - origX)/10, (finY - origY)/10);
            zoom_button_click((origX - finX)/5, (origY - finY)/5, 0);

            origX = finX;
            origY = finY;

            lightboxCanvas.renderAll();
        });

        lightboxCanvas.on('mouse:up', function (event) {
            isDown = false;
            lightboxCanvas.renderAll();
        });

        bt_metadata_hide();
        bt_imageMenu_hide();
    }

    function stopZoomXY(left, top){

        for (var i=0; i<croped_images.length; i++) {

            var image = croped_images[i];

            if(left < image.left) return false;
            if(top  < image.top)  return false;
            if(left + image.rects.width  > image.left + image.getWidth())  return false;
            if(top  + image.rects.height > image.top  + image.getHeight()) return false;
        }
        return true;
    }

    function stopZoomZ(left, top, width, height){

        for (var i=0; i<croped_images.length; i++) {

            var image = croped_images[i];

            if(width < 32 || height < 32) return false;
            if(left < image.left) return false;
            if(top  < image.top)  return false;
            if(left + width  >= image.left + image.getWidth())  return false;
            if(top  + height >= image.top  + image.getHeight()) return false;
        }
        return true;
    }

    function zoom_button_click(x,y,z) {

        var ratio, rectleft, recttop, rectwidth, rectheight;
        var element;
        for (var i=0; i<croped_images.length; i++) {
            element = croped_images[i];

            if (x || y){
                rectleft = element.rects.left + x;
                recttop  = element.rects.top  + y;

                if(stopZoomXY(rectleft, recttop)) element.rects.set({left: rectleft, top:recttop});

                croped_images3[i].rects.set({
                    left: croped_images3[i].oCoords.tl.x + ((element.rects.left - element.left) / element.scaleX) * croped_images3[i].scaleX,
                    top:  croped_images3[i].oCoords.tl.y + ((element.rects.top  - element.top)  / element.scaleY) * croped_images3[i].scaleY
                });

            }
            if (z) {
                ratio      = element.rects.width / element.rects.height;
                rectleft   = element.rects.left   + z / 2;
                recttop    = element.rects.top    + z / ratio / 2;
                rectwidth  = element.rects.width  - z;
                rectheight = element.rects.height - z / ratio;

                if(stopZoomZ(rectleft, recttop, rectwidth, rectheight)) element.rects.set({left:  rectleft,  top: recttop,
                    width: rectwidth, height: rectheight});

                croped_images3[i].rects.set({
                    left: croped_images3[i].oCoords.tl.x + ((element.rects.left - element.left) / element.scaleX) * croped_images3[i].scaleX,
                    top:  croped_images3[i].oCoords.tl.y + ((element.rects.top  - element.top)  / element.scaleY) * croped_images3[i].scaleY,
                    width:  (element.rects.width  / element.scaleX) * croped_images3[i].scaleX,
                    height: (element.rects.height / element.scaleY) * croped_images3[i].scaleY
                });
            }

            croped_images2[i].crop((element.rects.left - element.left) / element.scaleX,
                    (element.rects.top  - element.top)  / element.scaleY,
                    element.rects.width  / element.scaleX,
                    element.rects.height / element.scaleY, function () {lightboxCanvas.renderAll();
                    });

        }
    }

    function drawOriginal(){

        for (var i=0; i<croped_images.length; i++) {
            croped_images2[i].remove();
            croped_images3[i].remove();
            croped_images3[i].rects.remove();
        }

        croped_images.length = 0;
        croped_images2.length = 0;
        croped_images3.length = 0;

        lightboxCanvas.forEachObject(function (obj) {
            obj.visible = true;
            if(obj instanceof fabric.Image) obj.selectable = true;
        });

        lightboxCanvas.renderAll();
    }

    function draw_line_button_click() {

        var obj = lightboxCanvas.getActiveObject();
        if(obj === null) return;

        obj.set({old_left: obj.oCoords.tl.x, old_top: obj.oCoords.tl.y, old_width: obj.getWidth(),
            old_height: obj.getHeight(), old_angle: obj.getAngle()});

        lightboxCanvas.forEachObject(function (other) {
            other.selectable = false;
        });

        lightboxCanvas.on('mouse:down', function (o) {
            isDown = true;
            var pointer = lightboxCanvas.getPointer(o.e);

            var points = [pointer.x, pointer.y, pointer.x, pointer.y];
            obj.line = new fabric.Line(points, {
                strokeWidth: 2,
                stroke: 'red',
                originX: 'center',
                originY: 'center',
                selectable: false,
                controls: false
            });
            lightboxCanvas.add(obj.line);
        });

        lightboxCanvas.on('mouse:move', function (o) {
            if (!isDown) return;
            var pointer = lightboxCanvas.getPointer(o.e);
            obj.line.set({x2: pointer.x, y2: pointer.y});
            obj.line.setCoords();
            obj.line.bringToFront();
            //obj.line.selectable = false;
            lightboxCanvas.renderAll();
        });

        lightboxCanvas.on('mouse:up', function (o) {
            isDown = false;
            lightboxCanvas.off({'mouse:down': null, 'mouse:move': null, 'mouse:up': null});
            lightboxCanvas.forEachObject(function (other) {
                if(other instanceof fabric.Image) other.selectable = true;
            });
        });
    }

    function eraseLine(){
        var obj = lightboxCanvas.getActiveObject();
        lightboxCanvas.remove(obj.line);
        obj.line = null;
        lightboxCanvas.renderAll();
    }

    function hideLine(){
        var obj = lightboxCanvas.getActiveObject();
        obj.line.visible = !obj.line.visible;
        lightboxCanvas.renderAll();
    }

    function multMatrixVector(matrix, a, b){
        var result = [];

        result[0] = matrix[0]*a + matrix[2]*b + matrix[4];
        result[1] = matrix[1]*a + matrix[3]*b + matrix[5];
        return result;
    }

    function calcOverlappingLines(image1, image2){

        var scale  = [1,0,0,1,0,0];
        var rot    = [1,0,0,1,0,0];
        var trans  = [1,0,0,1,0,0];
        var origin = [1,0,0,1,0,0];

        var a = image2.line.x1;
        var b = image2.line.x2;
        var c = image2.line.y1;
        var d = image2.line.y2;

        var e = image1.line.x1;
        var f = image1.line.x2;
        var g = image1.line.y1;
        var h = image1.line.y2;

        var A = f-e;
        var B = h-g;
        var C = b-a;
        var D = d-c;

        var leng0 = Math.sqrt(Math.pow(A, 2)+Math.pow(B, 2));
        var leng1 = Math.sqrt(Math.pow(C, 2)+Math.pow(D, 2));
        var k = leng0/leng1;

        scale[0] = k;
        scale[3] = k;

        var cos  = (A*C+B*D)/(leng0*leng1);
        var z    = A*D-B*C;
        var acos = Math.acos(cos);
        if(z>0) acos = 2*Math.PI - acos;
        var angle_degrees = fabric.util.radiansToDegrees(acos);

        rot[0] =  Math.cos(acos);
        rot[1] =  Math.sin(acos);
        rot[2] = -Math.sin(acos);
        rot[3] =  Math.cos(acos);

        origin[4] = -image2.line.x1;
        origin[5] = -image2.line.y1;

        trans[4] = image1.line.x1;
        trans[5] = image1.line.y1;

        var result0 = fabric.util.multiplyTransformMatrices(rot,origin);
        var result1 = fabric.util.multiplyTransformMatrices(scale,result0);
        var result  = fabric.util.multiplyTransformMatrices(trans,result1);

        var transPoint1 = [];
        var transPoint2 = [];

        transPoint1 = multMatrixVector(result, image2.line.x1, image2.line.y1);
        transPoint2 = multMatrixVector(result, image2.line.x2, image2.line.y2);

        image2.line.set({x1: transPoint1[0], y1: transPoint1[1], x2: transPoint2[0], y2: transPoint2[1]});

        transPoint1 = multMatrixVector(result, image2.oCoords.tl.x, image2.oCoords.tl.y);

        image2.set({left: transPoint1[0], top: transPoint1[1]});
        image2.set({scaleX: k*image2.getScaleX(), scaleY: k*image2.getScaleY()});
        //image2.set({width: k*image2.getWidth(), height: k*image2.getHeight()});
        image2.set({angle: image2.getAngle()+angle_degrees});
        image2.setCoords();
        image2.set({old_left: image2.oCoords.tl.x, old_top: image2.oCoords.tl.y, old_width: image2.getWidth(), old_height: image2.getHeight()});
        image2.set({old_angle: image2.getAngle()});
        image2.set({opacity: 0.5});
        image2.bringToFront();
        image2.line.bringToFront();
        lightboxCanvas.renderAll();

    }

    function selectObjects(){
        isActive = true;
        lightboxCanvas.deactivateAll().renderAll();
    }

    function overlapping_lines_button_click(){

        if(selectObj.length != 2 ) {
            alert('Select Objects!');
            return;
        }

        //Remove filters
        selectObj[0].filters = [];
        selectObj[0].applyFilters();
        selectObj[1].filters = [];
        selectObj[1].applyFilters();

        calcOverlappingLines(selectObj[0], selectObj[1]);
        isActive = false;
    }

    var obj_selected;
    var isActive, selectObj = [];
    var isDown;

    function onChange(options) {
        options.target.bringToFront();
        changeOpacity(options.target);
        updateonChange(options.target);
        options.target.setCoords();
        $('#btn_remove_image').offset({top: options.target.top + $('#lightbox').offset().top, left: options.target.left + options.target.width * options.target.scaleX - $('#btn_remove_image').width() - 10});
        $('#btn_enlarge_image').offset({top: options.target.top + $('#lightbox').offset().top + options.target.height * options.target.scaleY - $('#btn_enlarge_image').height() - 10, left: options.target.left + options.target.width * options.target.scaleX - $('#btn_enlarge_image').width() - 10});
        lightboxCanvas.renderAll();
    }

    function onSelect(){
        fabric.util.toArray(document.getElementsByTagName('input'))
                .forEach(function(el){ el.disabled = false; });
        if(isActive) {
            var obj = lightboxCanvas.getActiveObject();
            if(selectObj.length == 2) selectObj = [];
            selectObj.push(obj);
            filter.sepia = 0.5;
            obj.filters.push(filter);
            obj.applyFilters(lightboxCanvas.renderAll.bind(lightboxCanvas));
        }
        //if (options.target instanceof fabric.RectLineImage)
        $("#textarea_metadata").val(lightboxCanvas.getActiveObject().metadata);
        $("#textarea_metadata").attr("disabled", true);
        obj_selected = lightboxCanvas.getActiveObject();
    }

    function changeOpacity(image){
        var intersected = false;
        lightboxCanvas.forEachObject(function (obj) {
            if (obj === image) return;
            if (obj instanceof fabric.Line) return;
            if (obj instanceof fabric.Rect) return;
            //options.target.opacity = (options.target.intersectsWithObject(obj) ? 0.5 : 1);
            if(image.isContainedWithinObject(obj) || image.intersectsWithObject(obj) || obj.isContainedWithinObject(image)) {
                intersected = true;
                image.opacity = 0.5;
                obj.opacity   = 1.0;
            }
            else if (!intersected) {
                image.opacity = 1.0;
            }
            lightboxCanvas.renderAll();
        });

    }

    function updateonChange(image) {

        if (image.line === null && image.rects === null){
            return;
        }
        else{
            var imageLeft = image.oCoords.tl.x;
            var imageTop = image.oCoords.tl.y;

            var sclX = image.getWidth() / image.old_width;
            var sclY = image.getHeight() / image.old_height;

            if(image.rects != null){
                var newleft   = imageLeft + (image.rects.left - image.old_left) * sclX;
                var newtop    = imageTop  + (image.rects.top - image.old_top)   * sclY;
                var newwidth  = image.rects.width  * sclX;
                var newheight = image.rects.height * sclY;

                image.updateRect(newleft, newtop, newwidth, newheight);
                image.rects.bringToFront();
            }

            if(image.line != null) {
                var newx1 = imageLeft + (image.line.x1 - image.old_left) * sclX;
                var newy1 = imageTop  + (image.line.y1 - image.old_top)  * sclY;
                var newx2 = imageLeft + (image.line.x2 - image.old_left) * sclX;
                var newy2 = imageTop  + (image.line.y2 - image.old_top)  * sclY;

                image.line.set({x1: newx1, y1: newy1, x2: newx2, y2: newy2});
                image.line.bringToFront();
            }

            image.set({old_left: imageLeft, old_top: imageTop, old_width: image.getWidth(), old_height: image.getHeight()});
        }
    }

    function onRotating(options) {
        options.target.bringToFront();
        changeOpacity(options.target);
        updateonRotating(options.target);
        options.target.setCoords();
        lightboxCanvas.renderAll();
    }

    function updateonRotating(image) {

        if (image.line === null && image.rects === null) return;
        else {
            var optgtLeft = image.oCoords.tl.x;
            var optgtTop  = image.oCoords.tl.y;
            var optAng    = image.getAngle();
            var deltaang  = optAng - image.old_angle;

            var sclX = image.getWidth() / image.old_width;
            var sclY = image.getHeight() / image.old_height;

            var p = new fabric.Point(0, 0);
            p = image.getCenterPoint();

            if(image.rects != null) {
                var newlt = fabric.util.rotatePoint(new fabric.Point(image.rects.left, image.rects.top), p,
                        fabric.util.degreesToRadians(deltaang));

                image.rects.set({left: newlt.x, top: newlt.y, angle: image.rects.angle + deltaang});
                image.rects.bringToFront();
            }

            if(image.line != null) {
                var newx1y1 = fabric.util.rotatePoint(new fabric.Point(image.line.x1,image.line.y1),
                        p, fabric.util.degreesToRadians(deltaang));
                var newx2y2 = fabric.util.rotatePoint(new fabric.Point(image.line.x2,image.line.y2),
                        p, fabric.util.degreesToRadians(deltaang));

                image.line.set({x1: newx1y1.x, y1: newx1y1.y, x2: newx2y2.x, y2: newx2y2.y});
                image.line.bringToFront();
            }

            image.set({old_left: optgtLeft, old_top: optgtTop, old_width: image.getWidth(), old_height: image.getHeight(), old_angle: optAng});
        }
    }

    var clone;

    function viewLarge(obj){
        //if (document.getElementById('check').checked){
        //var obj = lightboxCanvas.getActiveObject();

        view = true;

        lightboxCanvas.forEachObject(function (other) {
            other.visible = false;
            other.setControlsVisibility({bl: false, br: false, mb: false, ml: false, mr: false, mt: false, tl: false, tr: false, mtr: false});
        });

        clone = fabric.util.object.clone(obj);

        lightboxCanvas.deactivateAll();

        var radio_width = lightboxCanvas.width/obj.width;
        var radio_height = lightboxCanvas.height/obj.height;
        var radio;

        if(radio_width<=radio_height) radio = radio_width;
        else radio = radio_height;

        clone.originX = "center";
        clone.originY = "center";
        clone.left    = lightboxCanvas.width/2;
        clone.top     = lightboxCanvas.height/2;
        clone.scaleX  = radio;
        clone.scaleY  = radio;
        clone.opacity = 1;
        clone.visible = true;
        clone.selectable = false;

        lightboxCanvas.add(clone);
        clone.bringToFront();
        //}
        /*if(!document.getElementById('check').checked){
            clone.remove();

            lightboxCanvas.forEachObject(function (other) {
                other.visible = true;
                other.setControlsVisibility({bl: true, br: true, mb: true, ml: true, mr: true, mt: true, tl: true, tr: true, mtr: true});
            });
        }*/
        lightboxCanvas.renderAll();

        bt_metadata_hide();
        bt_imageMenu_hide();
    }

    function clearCanvas(){
        lightboxCanvas.clear();

        croped_images.length = 0;
        croped_images2.length = 0;
        croped_images3.length = 0;
        selected_image.length = 0;
    }

    // Essa função pode desaparecer, depois que o problema do botão sobre a image for resolvido.
    var view = false;
    function viewLarge2(){
       
        view = !view;

        if(view){
            var obj = lightboxCanvas.getActiveObject();

            lightboxCanvas.forEachObject(function (other) {
                other.visible = false;
                other.setControlsVisibility({bl: false, br: false, mb: false, ml: false, mr: false, mt: false, tl: false, tr: false, mtr: false});
            });

            clone = fabric.util.object.clone(obj);

            lightboxCanvas.deactivateAll();

            var radio_width = lightboxCanvas.width/obj.width;
            var radio_height = lightboxCanvas.height/obj.height;
            var radio;

            if(radio_width<=radio_height) radio = radio_width;
            else radio = radio_height;

            clone.originX = "center";
            clone.originY = "center";
            clone.left    = lightboxCanvas.width/2;
            clone.top     = lightboxCanvas.height/2;
            clone.scaleX  = radio;
            clone.scaleY  = radio;
            clone.opacity = 1;
            clone.visible = true;
            clone.selectable = false;
            clone.controls = false;

            lightboxCanvas.add(clone);
            clone.bringToFront();

            $('#metadata_div').hide();

        } else{
            clone.remove();

            lightboxCanvas.forEachObject(function (other) {
                other.visible = true;
                other.setControlsVisibility({bl: true, br: true, mb: true, ml: true, mr: true, mt: true, tl: true, tr: true, mtr: true});
            });

            $('#metadata_div').show();
        }
        lightboxCanvas.renderAll();

        bt_metadata_hide();
        bt_imageMenu_hide();
    }

    function btn_metadata_edit_click() {
        if(lightboxCanvas.getActiveObject() === null){
            alert('Select one object!');
            return;
        }
        
        $("#textarea_metadata").attr("disabled",!($("#textarea_metadata").attr("disabled")));
    }

    function btn_metadata_save_click() {
        obj_selected.metadata = $("#textarea_metadata").val();
    }

    var hovering_obj = null;
    $('#btn_remove_image').hide();
    $('#btn_enlarge_image').hide();

    lightboxCanvas.on('mouse:over', function(event) {
        if (event.target instanceof fabric.RectLineImage)
        {
            $('#btn_remove_image').show();
            $('#btn_enlarge_image').show();
            $('#btn_remove_image').offset({top: event.target.top + $('#lightbox').offset().top, left: event.target.left + event.target.width * event.target.scaleX - $('#btn_remove_image').width() - 10});
            $('#btn_enlarge_image').offset({top: event.target.top + $('#lightbox').offset().top + event.target.height * event.target.scaleY - $('#btn_enlarge_image').height() - 10, left: event.target.left + event.target.width * event.target.scaleX - $('#btn_enlarge_image').width() - 10});
            hovering_obj = event.target;
        }
    });

    lightboxCanvas.on('mouse:out', function(event) {
        if (event.target instanceof fabric.RectLineImage && event.target == hovering_obj)
        {
            $('#btn_remove_image').hide();
            $('#btn_enlarge_image').hide();
            hovering_obj = null;
        }
    });

    function btn_remove_image_click() {
        var dialog;
        if (hovering_obj != null)
        {
            dialog = confirm("Do you wish do remove this image?");
            if (dialog == true)
            {
                if (hovering_obj instanceof fabric.RectLineImage)
                {
                    if (hovering_obj.rects != null)
                        lightboxCanvas.remove(hovering_obj.rects);
                    if (hovering_obj.line != null)
                        lightboxCanvas.remove(hovering_obj.line);
                    lightboxCanvas.remove(hovering_obj);
                    $('#btn_remove_image').hide();
                    $('#btn_enlarge_image').hide();
                    hovering_obj = null;
                }
                else
                {
                    current_menu_workspace.splice(hovering_obj, 1);
                    $('#btn_remove_image').hide();
                    hovering_obj = null;
                    imageLoaded();
                }
            }
        }
    }

    function btn_enlarge_image_click() {
        viewLarge(hovering_obj);
        $('#btn_remove_image').hide();
        $('#btn_enlarge_image').hide();
        hovering_obj = null;
    }

    //Keyboard shortcuts:
    function objManip(prop, value) {
		    switch(prop) {
			    case 'zoomBy-x':
                    //obj.zoomBy(value, 0, 0, function(){demo.canvas.renderAll()});
                    zoom_button_click(value, 0, 0);
				break;

                case 'zoomBy-y':
                    //obj.zoomBy(0, value, 0, function(){demo.canvas.renderAll()});
                    zoom_button_click(0, value, 0);
				break;

                case 'zoomBy-z':
				    //obj.zoomBy(0, 0, value, function(){demo.canvas.renderAll()});
                    zoom_button_click(0, 0, value);
				break;

                //default:
				//    obj.set(prop, obj.get(prop) + value);
                //break;
		    }

		    /*if ('left' === prop || 'top' === prop) { obj.setCoords(); }
		    demo.canvas.renderAll();
		    return false;*/
	    }

    function initKeyboard() {
        document.onkeydown = function(event) {
            var key = window.event ? window.event.keyCode : event.keyCode;

            switch(key) {
                case 40: // -
                    if (event.shiftKey) {
                        objManip('zoomBy-z',-10);
                    }
                    else{
                        objManip('zoomBy-y', 1);
                    }
                    break;

                case 38: // +
                    if (event.shiftKey) {
                        objManip('zoomBy-z', 10);
                    }
                    else{
                        objManip('zoomBy-y', -1);
                    }
                    break;

                case 37: // left
                    objManip('zoomBy-x',-1);
                    break;

                case 39: // right
                    objManip('zoomBy-x',1);
                    break;
            }
        };
    }

    //Filters
    function applyNewFilters(option){
         var obj = lightboxCanvas.getActiveObject();

        if(option === 'EdgeDet') var filter = new fabric.Image.filters.EdgeCanny({});
        if(option === 'Gray') var filter = new fabric.Image.filters.GrayScale({});

        obj.filters.push(filter);
        obj.applyFilters(lightboxCanvas.renderAll.bind(lightboxCanvas));
    }

    function removeFilters(){
        var obj = lightboxCanvas.getActiveObject();

        obj.filters = [];
        obj.applyFilters();

        lightboxCanvas.renderAll();
    }

    function removeFiltersCanvas(){
        lightboxCanvas.forEachObject(function (obj) {
            obj.filters = [];
            obj.applyFilters();
        });
        lightboxCanvas.renderAll();
    }

</script>
